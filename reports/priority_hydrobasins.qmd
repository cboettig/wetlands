---
title: "Priority Watersheds for Wetland Conservation"
format: html
---

## Priority Watershed Analysis Methodology

This analysis identifies priority watersheds for wetland conservation based on a composite score that integrates multiple conservation criteria. We use HydroBASINS Level 6 watersheds as our spatial units of analysis.

### Data Sources

The analysis integrates the following global datasets:

1. **Wetlands**: Global Lakes and Wetlands Database (GLWD) - provides wetland extent and type
2. **Carbon Storage**: Vulnerable carbon data from Conservation International - represents irrecoverable carbon stocks
3. **Protected Areas**: World Database on Protected Areas (WDPA) - identifies existing conservation coverage
4. **Biodiversity Value**: Nature's Contributions to People (NCP) scores - biodiversity and ecosystem service importance
5. **Watersheds**: HydroBASINS Level 6 - watershed boundaries for analysis units

### Composite Score Calculation

Each watershed receives a **composite score** (0-1 scale) based on four equally-weighted criteria:

#### 1. Wetland Area (25% weight)
- **Metric**: Total hectares of wetlands within the watershed
- **Normalization**: Scaled relative to the largest wetland area in the country
- **Rationale**: Larger wetland areas provide greater ecosystem services and habitat

#### 2. Vulnerable Carbon (25% weight)
- **Metric**: Total vulnerable carbon stocks (metric tons) in wetland areas
- **Normalization**: Scaled relative to the highest carbon stock in the country
- **Rationale**: Identifies wetlands whose loss would release significant greenhouse gases

#### 3. Protection Gap (25% weight)
- **Metric**: Fraction of wetland area NOT currently protected (1 - protected_fraction)
- **Range**: 0 (fully protected) to 1 (completely unprotected)
- **Rationale**: Prioritizes watersheds with low current protection status

#### 4. Biodiversity & Ecosystem Services (25% weight)
- **Metric**: Average Nature's Contributions to People (NCP) score
- **Range**: 0 (low importance) to 1 (high importance)
- **Rationale**: Identifies areas critical for biodiversity and human well-being

### Formula

```
composite_score = (
    (wetland_area / max_wetland_area) * 0.25 +
    (total_carbon / max_total_carbon) * 0.25 +
    (1 - protected_fraction) * 0.25 +
    avg_ncp_score * 0.25
)
```

### Important Notes

- **GLWD Multiple Categories**: A single hexagon in GLWD can have multiple wetland type codes. We use `n_distinct(h8)` to avoid counting the same location multiple times.
- **H3 Hexagons**: All data is indexed using H3 hexagons at resolution 8, where each hex = 73.73 hectares
- **Country-Specific Normalization**: Scores are normalized within each country to identify relative priorities

## Setup

```{r setup, message=FALSE, warning=FALSE}
library(duckdbfs)
library(dplyr)
library(ggplot2)
library(tidyr)

# Configure DuckDB connection to S3
duckdb_secrets(
  key = "", 
  secret = "", 
  endpoint = "minio.carlboettiger.info"
)

# H3 hexagon area constant
hex_hectares <- 73.7327598

# Load datasets
countries <- open_dataset("s3://public-overturemaps/hex/countries.parquet", recursive = FALSE)
wetlands <- open_dataset("s3://public-wetlands/glwd/hex/**")
hydrobasins <- open_dataset("s3://public-hydrobasins/level_06/hexes/**")
carbon <- open_dataset("s3://public-carbon/hex/vulnerable-carbon/**")
wdpa <- open_dataset("s3://public-wdpa/hex/**")
ncp <- open_dataset("s3://public-ncp/hex/ncp_biod_nathab/**")

cat("âœ… Datasets loaded successfully\n")
```

## Analysis Function

```{r}
analyze_hydrobasins_for_country <- function(country_code, country_name, top_n = 3) {
  cat("\n", paste(rep("=", 80), collapse = ""), "\n")
  cat("Analyzing:", country_name, "(", country_code, ")\n")
  cat(paste(rep("=", 80), collapse = ""), "\n\n")
  
  # Step 1: Get wetlands in basins for this country
  basin_wetlands <- countries |>
    filter(country == country_code) |>
    inner_join(wetlands, by = c("h8", "h0")) |>
    filter(Z > 0) |>
    inner_join(hydrobasins, by = c("h8", "h0")) |>
    select(basin_id = id, PFAF_ID, UP_AREA, SUB_AREA, h8, h0)
  
  # Step 2: Calculate metrics for each basin
  basin_metrics <- basin_wetlands |>
    # Join with carbon data
    left_join(carbon, by = c("h8", "h0")) |>
    # Join with protected areas
    left_join(
      wdpa |> select(h8, h0, wdpa_present = OBJECTID),
      by = c("h8", "h0")
    ) |>
    # Join with NCP scores
    left_join(ncp, by = c("h8", "h0")) |>
    # Group by basin and calculate metrics
    group_by(basin_id, PFAF_ID, UP_AREA, SUB_AREA) |>
    summarise(
      # A. Wetland area
      wetland_hex_count = n_distinct(h8),
      wetland_area_hectares = round(wetland_hex_count * hex_hectares, 2),
      # B. Total carbon
      total_carbon = round(coalesce(sum(carbon, na.rm = TRUE), 0), 2),
      # C. Protected fraction
      protected_fraction = round(
        sum(!is.na(wdpa_present)) / n_distinct(h8), 
        3
      ),
      # D. Average NCP score
      avg_ncp_score = round(mean(ncp, na.rm = TRUE), 3),
      .groups = "drop"
    )
  
  # Step 3: Calculate composite scores
  results <- basin_metrics |>
    mutate(
      # Normalize each metric (0-1 scale)
      norm_wetland_area = wetland_area_hectares / max(wetland_area_hectares, na.rm = TRUE),
      norm_carbon = total_carbon / max(total_carbon, na.rm = TRUE),
      # Protection gap (inverse of protected fraction)
      protection_gap = 1 - protected_fraction,
      # Composite score (equal weights)
      composite_score = round(
        (norm_wetland_area * 0.25 +
         norm_carbon * 0.25 +
         protection_gap * 0.25 +
         coalesce(avg_ncp_score, 0) * 0.25),
        3
      )
    ) |>
    # Select final columns
    select(
      basin_id, PFAF_ID,
      upstream_area_km2 = UP_AREA,
      basin_area_km2 = SUB_AREA,
      wetland_hex_count,
      wetland_area_hectares,
      total_carbon,
      protected_fraction,
      avg_ncp_score,
      composite_score
    ) |>
    filter(wetland_hex_count > 0) |>
    arrange(desc(composite_score)) |>
    head(top_n) |>
    collect()
  
  if (nrow(results) > 0) {
    results <- results |>
      mutate(
        country = country_name,
        country_code = country_code
      )
    
    cat("Top", top_n, "Priority Hydrobasins in", country_name, ":\n\n")
    print(results |> 
      select(basin_id, PFAF_ID, wetland_area_hectares, total_carbon, 
             protected_fraction, avg_ncp_score, composite_score))
  } else {
    cat("No wetland data found for", country_name, "\n")
    results <- tibble(
      country = country_name,
      country_code = country_code
    )
  }
  
  return(results)
}
```

## North America: United States, Canada, and Mexico

```{r}
us_results <- analyze_hydrobasins_for_country('US', 'United States', top_n = 3)
```

```{r}
canada_results <- analyze_hydrobasins_for_country('CA', 'Canada', top_n = 3)
```

```{r}
mexico_results <- analyze_hydrobasins_for_country('MX', 'Mexico', top_n = 3)
```

## Asia: China, South Korea, and Thailand

```{r}
china_results <- analyze_hydrobasins_for_country('CN', 'China', top_n = 3)
```

```{r}
korea_results <- analyze_hydrobasins_for_country('KR', 'South Korea', top_n = 3)
```

```{r}
thailand_results <- analyze_hydrobasins_for_country('TH', 'Thailand', top_n = 3)
```

## Europe: United Kingdom, France, and Spain

```{r}
uk_results <- analyze_hydrobasins_for_country('GB', 'United Kingdom', top_n = 3)
```

```{r}
france_results <- analyze_hydrobasins_for_country('FR', 'France', top_n = 3)
```

```{r}
spain_results <- analyze_hydrobasins_for_country('ES', 'Spain', top_n = 3)
```

## South America: Brazil and Chile

```{r}
brazil_results <- analyze_hydrobasins_for_country('BR', 'Brazil', top_n = 3)
```

```{r}
chile_results <- analyze_hydrobasins_for_country('CL', 'Chile', top_n = 3)
```

## Australia

```{r}
australia_results <- analyze_hydrobasins_for_country('AU', 'Australia', top_n = 3)
```

## India

```{r}
india_results <- analyze_hydrobasins_for_country('IN', 'India', top_n = 3)
```

## Summary: Combined Results

```{r}
# Combine all results
all_results <- bind_rows(
  us_results, canada_results, mexico_results,
  china_results, korea_results, thailand_results,
  uk_results, france_results, spain_results,
  brazil_results, chile_results,
  australia_results, india_results
)

cat("\n", paste(rep("=", 80), collapse = ""), "\n")
cat("SUMMARY: Top Priority Hydrobasins Across All Countries\n")
cat(paste(rep("=", 80), collapse = ""), "\n\n")

print(all_results |> 
  select(country, basin_id, PFAF_ID, wetland_area_hectares, 
         total_carbon, protected_fraction, avg_ncp_score, composite_score))

# Save to CSV
write.csv(all_results, 'priority_hydrobasins_results_r.csv', row.names = FALSE)
cat("\nResults saved to: priority_hydrobasins_results_r.csv\n")
```

## Visualization: Comparative Analysis

```{r fig.width=14, fig.height=10}
# Create comparison plots
library(patchwork)

# A. Wetland Area by Country
p1 <- all_results |>
  group_by(country) |>
  summarise(total_wetland = sum(wetland_area_hectares, na.rm = TRUE)) |>
  arrange(total_wetland) |>
  mutate(country = factor(country, levels = country)) |>
  ggplot(aes(x = country, y = total_wetland)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "A. Wetland Area in Top Hydrobasins by Country",
    x = NULL,
    y = "Total Wetland Area (hectares)"
  ) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank())

# B. Carbon Storage by Country
p2 <- all_results |>
  group_by(country) |>
  summarise(total_carbon = sum(total_carbon, na.rm = TRUE)) |>
  arrange(total_carbon) |>
  mutate(country = factor(country, levels = country)) |>
  ggplot(aes(x = country, y = total_carbon)) +
  geom_col(fill = "darkgreen") +
  coord_flip() +
  labs(
    title = "B. Carbon Storage in Top Hydrobasins by Country",
    x = NULL,
    y = "Total Vulnerable Carbon"
  ) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank())

# C. Protected Fraction by Country
p3 <- all_results |>
  group_by(country) |>
  summarise(avg_protected = mean(protected_fraction, na.rm = TRUE)) |>
  arrange(avg_protected) |>
  mutate(country = factor(country, levels = country)) |>
  ggplot(aes(x = country, y = avg_protected)) +
  geom_col(fill = "orange") +
  coord_flip() +
  scale_y_continuous(limits = c(0, 1)) +
  labs(
    title = "C. Protection Coverage in Top Hydrobasins by Country",
    x = NULL,
    y = "Average Protected Fraction"
  ) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank())

# D. NCP Score by Country
p4 <- all_results |>
  group_by(country) |>
  summarise(avg_ncp = mean(avg_ncp_score, na.rm = TRUE)) |>
  arrange(avg_ncp) |>
  mutate(country = factor(country, levels = country)) |>
  ggplot(aes(x = country, y = avg_ncp)) +
  geom_col(fill = "purple") +
  coord_flip() +
  scale_y_continuous(limits = c(0, 1)) +
  labs(
    title = "D. Nature Contributions in Top Hydrobasins by Country",
    x = NULL,
    y = "Average NCP Score"
  ) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank())

# Combine plots
(p1 | p2) / (p3 | p4)

ggsave('priority_hydrobasins_comparison_r.png', width = 14, height = 10, dpi = 300)
```

## Composite Score Distribution

```{r fig.width=12, fig.height=6}
all_results |>
  ggplot(aes(x = reorder(country, composite_score, FUN = median), 
             y = composite_score)) +
  geom_boxplot(fill = "#66c2a5", alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 2) +
  coord_flip() +
  labs(
    title = "Distribution of Composite Scores Across Countries",
    subtitle = "Top 3 Hydrobasins Each",
    x = NULL,
    y = "Composite Score"
  ) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank())

ggsave('composite_score_distribution_r.png', width = 12, height = 6, dpi = 300)
```

## Key Findings

### Methodology

For each country, we identified the top 3 Level 6 HydroBASINS based on a composite score that equally weights four key metrics:

1. **Wetland Area (25%)**: Total hectares of wetlands from GLWD
2. **Carbon Storage (25%)**: Vulnerable carbon in wetlands
3. **Protection Status (25%)**: Fraction of wetlands within WDPA protected areas
4. **Nature's Contributions (25%)**: Average NCP biodiversity score

### Interpretation

The composite score helps identify hydrobasins that balance multiple conservation priorities:
- High wetland area indicates ecological significance
- High carbon storage suggests climate mitigation importance
- Low protection fraction highlights conservation gaps
- High NCP scores indicate biodiversity value and ecosystem services

### Next Steps

The results can be used to:
- Prioritize watersheds for conservation investment
- Identify protection gaps in high-value wetlands
- Support climate and biodiversity policy decisions
- Guide restoration and protection efforts
