apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: llm-proxy-ingress
  annotations:
    # Enable CORS for this Ingress
    haproxy.org/cors-enable: "true"
    
    # Allow requests from any origin (wildcard works when credentials is false)
    haproxy.org/cors-allow-origin: "*"
    
    # Allow POST (for LLM requests), GET (for health checks), and OPTIONS (for preflight)
    haproxy.org/cors-allow-methods: "GET, POST, OPTIONS"
    
    # Allow necessary headers including Authorization for API key
    haproxy.org/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Accept,Accept-Encoding,Accept-Language,Connection,Host,Origin,Referer,Sec-Fetch-Dest,Sec-Fetch-Mode,Sec-Fetch-Site,Priority,Authorization"
    
    # Expose headers in responses
    haproxy.org/cors-expose-headers: "Content-Length,Content-Range"
    
    # Cannot use credentials with wildcard origin
    haproxy.org/cors-allow-credentials: "false"
    
    # Cache preflight responses for 10 minutes
    haproxy.org/cors-max-age: "600"
    
    # Increase timeout for LLM requests (10 minutes for tool calling)
    haproxy.org/timeout-http-request: "600s"
    haproxy.org/timeout-server: "600s"
    haproxy.org/timeout-client: "600s"
    haproxy.org/timeout-connect: "30s"
    
    # Return CORS headers even on error responses
    haproxy.org/error-files: "true"

spec:
  ingressClassName: haproxy
  tls:
    - hosts:
        - llm-proxy.nrp-nautilus.io
      # Uncomment and add secretName if managing your own certificates
      # secretName: llm-proxy-tls
  rules:
    - host: llm-proxy.nrp-nautilus.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: llm-proxy
                port:
                  number: 8002
